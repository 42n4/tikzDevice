% !TEX root = tikzDevice.Rnw
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{Sweave}{}

\RequirePackage{graphicx,fancyvrb}
\IfFileExists{upquote.sty}{\RequirePackage{upquote}}{}

\DefineVerbatimEnvironment{Scode}{Verbatim}{fontshape=sl}

% Magic happening here- avert your eyes!

% Ugly hack to make listings work "the way *I* want it to work" :p
% Basically what is happening is that you *CANNOT* embed listings,
% or fancyvrb for that matter, inside another macro. But I *really* *really*
% want to. Sooooooo.... all the makeatletter voodoo basically captures
% the output inside this environment and saves it to a temporary file
% without mangling it. \lstinputlisting is then used to read that output
% back in since it is perfectly happy with being embedded inside other
% environments.
\makeatletter 
\newwrite\lstvrb@out 
\newenvironment{Schunk}{% 
  \begingroup 
  \@bsphack 
  \immediate\openout\lstvrb@out\jobname.lst 
  \let\do\@makeother\dospecials\catcode`\^^M\active 
  \def\verbatim@processline{% 
    \immediate\write\lstvrb@out{\the\verbatim@line}}% 
  \verbatim@start}{% 
  \immediate\closeout\lstvrb@out 
  \@esphack 
  \endgroup 
  
  % Normal, sane, LaTeX code resumes here.
  \begin{tikzpicture}
  	\node[code body]{
		% Okay... so we've hijacked Sweave's main output
		% environment, Schunk. We can now play with the
		% results as we see fit.
	    \lstinputlisting[style = sweaveChunk]{\jobname.lst} 
	 };
  \end{tikzpicture}}
\makeatother 



\newcommand{\Sconcordance}[1]{%
  \ifx\pdfoutput\undefined%
  \csname newcount\endcsname\pdfoutput\fi%
  \ifcase\pdfoutput\special{#1}%
  \else\immediate\pdfobj{#1}\fi}
