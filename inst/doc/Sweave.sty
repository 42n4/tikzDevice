% !TEX root = tikzDevice.Rnw
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{Sweave}{}

\RequirePackage{graphicx,fancyvrb}
\IfFileExists{upquote.sty}{\RequirePackage{upquote}}{}

\DefineVerbatimEnvironment{Scode}{Verbatim}{fontshape=sl}

% Magic happening here- avert your eyes!

% Ugly hack to make listings work "the way *I* want it to work" :p
% Basically what is happening is that you *CANNOT* embed listings,
% or fancyvrb for that matter, inside another macro. But I *really* *really*
% want to. Sooooooo.... all the makeatletter voodoo basically captures
% the output inside this environment and saves it to a temporary file
% without mangling it. \lstinputlisting is then used to read that output
% back in since it is perfectly happy with being embedded inside other
% environments.
\makeatletter 
\newwrite\lstvrb@out 
\newenvironment{Schunk}[1][]{% 
  % Set up some pgfKeys to save input into this enviornment
  \pgfkeys{/code nodes/title/.store in=\@codeNodeTitle}
  \pgfkeys{/code nodes/footer/.store in=\@codeNodeFooter}
  \pgfkeys{/code nodes/.cd,#1}
  
  \begingroup 
  \@bsphack 
  \immediate\openout\lstvrb@out\jobname.lst 
  \let\do\@makeother\dospecials\catcode`\^^M\active 
  \def\verbatim@processline{% 
    \immediate\write\lstvrb@out{\the\verbatim@line}}% 
  \verbatim@start}{% 
  \immediate\closeout\lstvrb@out 
  \@esphack 
  \endgroup 
  
  % Normal, sane, LaTeX code resumes here.
  \begin{tikzpicture}
	% Okay... so we've hijacked Sweave's main output
	% environment, Schunk. We can now play with the
	% results as we see fit.
  	\node[code body] (code node body) {
	    \lstinputlisting[style = sweaveChunk]{\jobname.lst}%
	 };
	 
	 % Basically, \relax does jack squat if the macro \@codeNodeTitle
	 % is not defined. It's sole purpose in life is to allow us to get to the 
	 % \else statement without LaTeX freaking out.

	 \ifx \@codeNodeTitle \undefined
	   \relax
	 \else
	 	\node[code title body] (code node title) {
			\@codeNodeTitle
		};
		\draw[code title outline] (code node title.south west) --
			(code node title.south east) [rounded corners] --
			(code node title.north east) --
			(code node title.north west) [sharp corners] --
			cycle;
	 \fi
	 
	 % And the footer
	  \ifx \@codeNodeFooter \undefined
	   \relax
	 \else
	 	\node[code footer] at (code node body.south) {
			\@codeNodeFooter
		};
	 \fi
	 
	\end{tikzpicture}
}
\makeatother 



\newcommand{\Sconcordance}[1]{%
  \ifx\pdfoutput\undefined%
  \csname newcount\endcsname\pdfoutput\fi%
  \ifcase\pdfoutput\special{#1}%
  \else\immediate\pdfobj{#1}\fi}
